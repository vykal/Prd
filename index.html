<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktívny Video Meeting</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            background: lightblue;
        }

        video {
            position: absolute;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: 150px;
            height: 100px;
            object-fit: cover;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase konfigurácie
    const firebaseConfigGame = {
        apiKey: "AIzaSyACWLI7L0zhZk7RFQyEXlOyQjtMPF-MgDw",
        authDomain: "hrav-1a742.firebaseapp.com",
        databaseURL: "https://hrav-1a742-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "hrav-1a742",
        storageBucket: "hrav-1a742.firebasestorage.app",
        messagingSenderId: "1093772001619",
        appId: "1:1093772001619:web:97d8e6dd9d5cd28da761a6",
        measurementId: "G-GFVZ6ZD5RE"
    };

    const firebaseConfigVideo = {
        apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
        authDomain: "videjo-d0996.firebaseapp.com",
        databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "videjo-d0996",
        storageBucket: "videjo-d0996.firebasestorage.app",
        messagingSenderId: "175126755237",
        appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
        measurementId: "G-6Q2BJX1FE5"
    };

    const appGame = initializeApp(firebaseConfigGame, "gameApp");
    const appVideo = initializeApp(firebaseConfigVideo, "videoApp");
    const dbGame = getDatabase(appGame);
    const dbVideo = getDatabase(appVideo);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const playerId = `player_${Math.random().toString(36).substring(2, 9)}`;
    const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

    const player = {
        id: playerId,
        x: Math.random() * (canvas.width - 150),
        y: Math.random() * (canvas.height - 100),
        width: 150,
        height: 100,
        videoElement: null
    };

    const players = {};

    const addPlayerVideo = (player) => {
        const video = document.createElement('video');
        video.srcObject = player.id === playerId ? localStream : null;
        video.autoplay = true;
        video.muted = player.id === playerId;
        video.style.left = `${player.x}px`;
        video.style.top = `${player.y}px`;
        video.setAttribute("data-id", player.id);
        document.body.appendChild(video);
        player.videoElement = video;
    };

    const updatePlayerPosition = (player) => {
        if (player.videoElement) {
            player.videoElement.style.left = `${player.x}px`;
            player.videoElement.style.top = `${player.y}px`;
        }
    };

    const sendPlayerData = () => {
        set(ref(dbGame, `players/${playerId}`), {
            id: player.id,
            x: player.x,
            y: player.y
        });
    };

    const removePlayer = () => {
        const playerRef = ref(dbGame, `players/${playerId}`);
        remove(playerRef);
    };

    window.addEventListener('beforeunload', removePlayer);

    onValue(ref(dbGame, "players"), (snapshot) => {
        const data = snapshot.val() || {};
        Object.keys(data).forEach(id => {
            if (id === playerId) return;
            if (!players[id]) {
                players[id] = { ...data[id] };
                addPlayerVideo(players[id]);
            } else {
                players[id].x = data[id].x;
                players[id].y = data[id].y;
                updatePlayerPosition(players[id]);
            }
        });

        Object.keys(players).forEach(id => {
            if (!data[id]) {
                document.querySelector(`[data-id="${id}"]`).remove();
                delete players[id];
            }
        });
    });

    window.addEventListener('keydown', (e) => {
        const speed = 10;
        switch (e.key) {
            case "ArrowLeft":
                player.x -= speed;
                break;
            case "ArrowRight":
                player.x += speed;
                break;
            case "ArrowUp":
                player.y -= speed;
                break;
            case "ArrowDown":
                player.y += speed;
                break;
        }

        updatePlayerPosition(player);
        sendPlayerData();
    });

    addPlayerVideo(player);
    sendPlayerData();

    // WebRTC video meeting logic
    const config = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    const peers = {};
    const signalsRef = ref(dbVideo, "signals");

    const createPeerConnection = (id, stream) => {
        const peerConnection = new RTCPeerConnection(config);
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        peerConnection.ontrack = (event) => {
            const [remoteStream] = event.streams;
            if (players[id]) players[id].videoElement.srcObject = remoteStream;
        };

        return peerConnection;
    };

    onValue(signalsRef, (snapshot) => {
        const signals = snapshot.val() || {};
        Object.keys(signals).forEach(key => {
            const { from, offer, candidate } = signals[key];
            if (from === playerId) return;

            if (!peers[from]) {
                peers[from] = createPeerConnection(from, localStream);
            }

            if (offer) {
                peers[from].setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => peers[from].createAnswer())
                    .then(answer => peers[from].setLocalDescription(answer))
                    .then(() => push(signalsRef, { from: playerId, answer: peers[from].localDescription }));
            }

            if (candidate) {
                peers[from].addIceCandidate(new RTCIceCandidate(candidate));
            }
        });
    });
</script>
</body>
</html>
