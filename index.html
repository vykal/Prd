<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stretnutie</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
    <style>
        body {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        video {
            width: 300px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, push, onChildAdded, onChildRemoved, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
            authDomain: "videjo-d0996.firebaseapp.com",
            databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "videjo-d0996",
            storageBucket: "videjo-d0996.appspot.com",
            messagingSenderId: "175126755237",
            appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
            measurementId: "G-6Q2BJX1FE5"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const userId = `user_${Math.random().toString(36).substr(2, 9)}`;
        const usersRef = ref(database, "users");

        const localVideo = document.createElement("video");
        localVideo.autoplay = true;
        localVideo.muted = true;
        document.body.appendChild(localVideo);

        let localStream = null;
        const peerConnections = {};
        const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // Inicializácia lokálneho videa
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                localVideo.srcObject = stream;

                // Pridanie používateľa do databázy
                const userRef = ref(database, `users/${userId}`);
                set(userRef, { id: userId, timestamp: Date.now() });
                window.addEventListener("beforeunload", () => {
                    remove(userRef);
                });

                // Počúvanie na nových používateľov
                onChildAdded(usersRef, snapshot => {
                    const newUserId = snapshot.val().id;
                    if (newUserId !== userId) {
                        createPeerConnection(newUserId);
                    }
                });

                // Odstránenie používateľa pri odchode
                onChildRemoved(usersRef, snapshot => {
                    const removedUserId = snapshot.val().id;
                    if (peerConnections[removedUserId]) {
                        peerConnections[removedUserId].close();
                        delete peerConnections[removedUserId];
                    }
                });
            })
            .catch(err => console.error("Prístup ku kamere bol zamietnutý:", err));

        function createPeerConnection(remoteUserId) {
            const peerConnection = new RTCPeerConnection(configuration);
            peerConnections[remoteUserId] = peerConnection;

            // Pridanie lokálneho streamu do PeerConnection
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Vytvorenie ICE kandidátov
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    const candidateRef = ref(database, `candidates/${remoteUserId}`);
                    push(candidateRef, { from: userId, candidate: event.candidate });
                }
            };

            // Počúvanie na prichádzajúce streamy
            peerConnection.ontrack = event => {
                const remoteVideo = document.createElement("video");
                remoteVideo.autoplay = true;
                remoteVideo.srcObject = event.streams[0];
                document.body.appendChild(remoteVideo);
            };

            // Vytvorenie a odoslanie offer
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    const offerRef = ref(database, `offers/${remoteUserId}`);
                    set(offerRef, { from: userId, offer: peerConnection.localDescription });
                });

            listenForAnswers(remoteUserId);
        }

        function listenForAnswers(remoteUserId) {
            const answerRef = ref(database, `answers/${userId}`);
            onChildAdded(answerRef, snapshot => {
                const data = snapshot.val();
                if (data.from === remoteUserId) {
                    const desc = new RTCSessionDescription(data.answer);
                    peerConnections[remoteUserId].setRemoteDescription(desc);
                }
            });
        }

        const offersRef = ref(database, `offers/${userId}`);
        onChildAdded(offersRef, snapshot => {
            const data = snapshot.val();
            if (data && !peerConnections[data.from]) {
                const peerConnection = new RTCPeerConnection(configuration);
                peerConnections[data.from] = peerConnection;

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        const candidateRef = ref(database, `candidates/${data.from}`);
                        push(candidateRef, { from: userId, candidate: event.candidate });
                    }
                };

                peerConnection.ontrack = event => {
                    const remoteVideo = document.createElement("video");
                    remoteVideo.autoplay = true;
                    remoteVideo.srcObject = event.streams[0];
                    document.body.appendChild(remoteVideo);
                };

                peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        const answerRef = ref(database, `answers/${data.from}`);
                        set(answerRef, { from: userId, answer: peerConnection.localDescription });
                    });

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }
        });

        const candidatesRef = ref(database, `candidates/${userId}`);
        onChildAdded(candidatesRef, snapshot => {
            const data = snapshot.val();
            if (data && peerConnections[data.from]) {
                const candidate = new RTCIceCandidate(data.candidate);
                peerConnections[data.from].addIceCandidate(candidate);
            }
        });
    </script>
</body>
</html>
