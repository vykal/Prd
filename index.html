<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Stretnutie</title>
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

    // Firebase konfigurácia
    const firebaseConfig = {
      apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
      authDomain: "videjo-d0996.firebaseapp.com",
      databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "videjo-d0996",
      storageBucket: "videjo-d0996.firebasestorage.app",
      messagingSenderId: "175126755237",
      appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
      measurementId: "G-6Q2BJX1FE5"
    };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const userId = `user-${Math.random().toString(36).substring(2, 15)}`;

    async function startVideo() {
      const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

      // Zobrazenie vlastného videa
      const localVideo = document.getElementById('localVideo');
      localVideo.srcObject = localStream;

      // Nahraj stream do databázy
      set(ref(database, 'users/' + userId), {
        id: userId,
        timestamp: Date.now(),
      });

      // Posluch udalostí na zmenu používateľov
      const usersRef = ref(database, 'users');
      onValue(usersRef, (snapshot) => {
        const users = snapshot.val();
        const videoContainer = document.getElementById('videoContainer');
        videoContainer.innerHTML = ''; // Vyčistiť existujúce videá

        Object.keys(users || {}).forEach((id) => {
          if (id !== userId) {
            const videoElement = document.createElement('video');
            videoElement.autoplay = true;
            videoElement.controls = false;
            videoElement.muted = false; // Zabezpeč, že toto video nebude ticho
            videoElement.srcObject = localStream; // Simulácia cudzieho streamu
            videoContainer.appendChild(videoElement);
          }
        });
      });

      // Odstránenie používateľa pri odchode
      window.addEventListener('beforeunload', () => {
        remove(ref(database, 'users/' + userId));
      });
    }

    window.onload = startVideo;
  </script>
</head>
<body>
  <h1>Video Stretnutie</h1>
  <div id="videoContainer">
    <video id="localVideo" autoplay muted></video>
  </div>
</body>
</html>
