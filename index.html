<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktívny Video Meeting</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            position: relative;
        }
        canvas {
            display: block;
            background: lightblue;
        }
        video {
            position: absolute;
            border: 2px solid white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase konfigurácia pre polohu
    const positionFirebaseConfig = {
        apiKey: "AIzaSyACWLI7L0zhZk7RFQyEXlOyQjtMPF-MgDw",
        authDomain: "hrav-1a742.firebaseapp.com",
        databaseURL: "https://hrav-1a742-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "hrav-1a742",
        storageBucket: "hrav-1a742.firebasestorage.app",
        messagingSenderId: "1093772001619",
        appId: "1:1093772001619:web:97d8e6dd9d5cd28da761a6"
    };

    // Firebase konfigurácia pre video signály
    const videoFirebaseConfig = {
        apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
        authDomain: "videjo-d0996.firebaseapp.com",
        databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "videjo-d0996",
        storageBucket: "videjo-d0996.firebasestorage.app",
        messagingSenderId: "175126755237",
        appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c"
    };

    // Inicializácia Firebase
    const positionApp = initializeApp(positionFirebaseConfig, "positionApp");
    const videoApp = initializeApp(videoFirebaseConfig, "videoApp");
    const positionDb = getDatabase(positionApp);
    const videoDb = getDatabase(videoApp);

    // Hlavné prvky
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Lokálne video
    const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const videoElement = document.createElement("video");
    videoElement.srcObject = localStream;
    videoElement.autoplay = true;
    videoElement.muted = true; // Vypnutie vlastného zvuku
    videoElement.style.width = "100px";
    videoElement.style.height = "100px";
    document.body.appendChild(videoElement);

    // Unikátne ID hráča
    const playerId = `player_${Math.random().toString(36).substring(2, 9)}`;
    const player = {
        id: playerId,
        x: Math.random() * (canvas.width - 100),
        y: Math.random() * (canvas.height - 100),
        width: 100,
        height: 100,
    };
    const players = {};

    // Ovládanie hráča
    const keys = {};
    window.addEventListener("keydown", (e) => keys[e.key] = true);
    window.addEventListener("keyup", (e) => keys[e.key] = false);

    function movePlayer() {
        if (keys["ArrowLeft"]) player.x -= 5;
        if (keys["ArrowRight"]) player.x += 5;
        if (keys["ArrowUp"]) player.y -= 5;
        if (keys["ArrowDown"]) player.y += 5;

        // Obmedziť pohyb v hraniciach
        player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
        player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
    }

    function drawPlayers() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        Object.values(players).forEach(p => {
            const video = document.querySelector(`[data-id="${p.id}"]`);
            if (video) {
                video.style.left = `${p.x}px`;
                video.style.top = `${p.y}px`;
            }
        });
    }

    // Pridanie lokálneho videa
    videoElement.dataset.id = playerId;

    // Aktualizácia pozície do Firebase
    function sendPosition() {
        set(ref(positionDb, `players/${player.id}`), player);
    }

    // Načítanie hráčov z Firebase
    const playersRef = ref(positionDb, "players");
    onValue(playersRef, (snapshot) => {
        const data = snapshot.val() || {};
        Object.keys(data).forEach(id => {
            players[id] = data[id];
            if (!document.querySelector(`[data-id="${id}"]`) && id !== playerId) {
                const remoteVideo = document.createElement("video");
                remoteVideo.dataset.id = id;
                remoteVideo.style.position = "absolute";
                remoteVideo.style.width = "100px";
                remoteVideo.style.height = "100px";
                remoteVideo.autoplay = true;
                document.body.appendChild(remoteVideo);
            }
        });
        drawPlayers();
    });

    // Odstránenie hráča pri odpojení
    window.addEventListener("beforeunload", () => {
        remove(ref(positionDb, `players/${player.id}`));
    });

    // Herná slučka
    function gameLoop() {
        movePlayer();
        sendPosition();
        requestAnimationFrame(gameLoop);
    }
    gameLoop();

    // Video signály
    // WebRTC konfigurácia a logika sa použije z predchádzajúceho kódu pre video meeting.
    // Tento kód môžete vložiť sem na správu video streamov.
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
const peers = {};
const pendingCandidates = {};

function connectToNewUser(id) {
    const peerConnection = new RTCPeerConnection(config);

    // Pridanie lokálneho videa
    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });

    // Odosielanie ICE kandidátov
    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            set(ref(videoDb, `signals/${id}/${playerId}`), {
                candidate: event.candidate.toJSON(),
            });
        }
    };

    // Pridanie prijatého videa
    peerConnection.ontrack = event => {
        const [remoteStream] = event.streams;
        const remoteVideo = document.querySelector(`[data-id="${id}"]`);
        if (remoteVideo) {
            remoteVideo.srcObject = remoteStream;
        }
    };

    peers[id] = peerConnection;

    // Vytvorenie ponuky
    peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer);
        set(ref(videoDb, `signals/${id}/${playerId}`), { offer });
    });
}

// Správa signálov z Firebase
onValue(ref(videoDb, `signals/${playerId}`), snapshot => {
    const signals = snapshot.val();
    if (!signals) return;

    Object.keys(signals).forEach(fromId => {
        const { offer, answer, candidate } = signals[fromId];
        let peerConnection = peers[fromId];

        // Pripojenie nového používateľa
        if (!peerConnection) {
            peerConnection = new RTCPeerConnection(config);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    set(ref(videoDb, `signals/${fromId}/${playerId}`), {
                        candidate: event.candidate.toJSON(),
                    });
                }
            };

            peerConnection.ontrack = event => {
                const [remoteStream] = event.streams;
                const remoteVideo = document.querySelector(`[data-id="${fromId}"]`);
                if (remoteVideo) {
                    remoteVideo.srcObject = remoteStream;
                }
            };

            peers[fromId] = peerConnection;
        }

        // Spracovanie ponuky
        if (offer && peerConnection.signalingState === "stable") {
            peerConnection.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
                peerConnection.createAnswer().then(answer => {
                    peerConnection.setLocalDescription(answer);
                    set(ref(videoDb, `signals/${fromId}/${playerId}`), { answer });
                });
            });
        }

        // Spracovanie odpovede
        if (answer) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // Spracovanie ICE kandidátov
        if (candidate) {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }
    });
});
</script>
</body>
</html>
