<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktívny Video Meeting</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            background: lightblue;
        }

        #videos {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        video {
            position: absolute;
            border: 2px solid white;
            border-radius: 10px;
            width: 100px;
            height: 75px;
            object-fit: cover;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .button {
            width: 60px;
            height: 60px;
            background: gray;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            line-height: 60px;
            border-radius: 10px;
            user-select: none;
            cursor: pointer;
        }

        .button:active {
            background: darkgray;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="videos"></div>
    <div class="controls">
        <div class="button" id="left">◀</div>
        <div class="button" id="up">▲</div>
        <div class="button" id="right">▶</div>
        <div class="button" id="down">▼</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyACWLI7L0zhZk7RFQyEXlOyQjtMPF-MgDw",
            authDomain: "hrav-1a742.firebaseapp.com",
            databaseURL: "https://hrav-1a742-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hrav-1a742",
            storageBucket: "hrav-1a742.appspot.com",
            messagingSenderId: "1093772001619",
            appId: "1:1093772001619:web:97d8e6dd9d5cd28da761a6"
        };

        // Inicializácia Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const videosContainer = document.getElementById('videos');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const playerId = `player_${Math.random().toString(36).substring(2, 9)}`;
        const player = {
            id: playerId,
            x: Math.random() * (canvas.width - 100),
            y: Math.random() * (canvas.height - 75),
            width: 100,
            height: 75
        };

        const players = {};
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        const peers = {};
        const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

        const addVideoStream = (stream, id, x, y) => {
            let video = document.querySelector(`video[data-id="${id}"]`);
            if (!video) {
                video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.dataset.id = id;
                video.style.left = `${x}px`;
                video.style.top = `${y}px`;
                videosContainer.appendChild(video);
            }
        };

        addVideoStream(localStream, playerId, player.x, player.y);

        function sendDataToFirebase() {
            set(ref(db, `players/${player.id}`), { ...player });
        }

        onValue(ref(db, 'players'), (snapshot) => {
            const data = snapshot.val() || {};
            Object.keys(data).forEach((id) => {
                if (id !== playerId) {
                    const otherPlayer = data[id];
                    if (!peers[id]) connectToNewUser(id, otherPlayer);
                    const video = document.querySelector(`video[data-id="${id}"]`);
                    if (video) {
                        video.style.left = `${otherPlayer.x}px`;
                        video.style.top = `${otherPlayer.y}px`;
                    }
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowLeft': player.x -= 10; break;
                case 'ArrowRight': player.x += 10; break;
                case 'ArrowUp': player.y -= 10; break;
                case 'ArrowDown': player.y += 10; break;
            }
            sendDataToFirebase();
        });

        // Mobilné dotykové ovládanie
        const leftButton = document.getElementById('left');
        const rightButton = document.getElementById('right');
        const upButton = document.getElementById('up');
        const downButton = document.getElementById('down');

        leftButton.addEventListener('mousedown', () => { player.x -= 10; sendDataToFirebase(); });
        rightButton.addEventListener('mousedown', () => { player.x += 10; sendDataToFirebase(); });
        upButton.addEventListener('mousedown', () => { player.y -= 10; sendDataToFirebase(); });
        downButton.addEventListener('mousedown', () => { player.y += 10; sendDataToFirebase(); });

        leftButton.addEventListener('touchstart', () => { player.x -= 10; sendDataToFirebase(); });
        rightButton.addEventListener('touchstart', () => { player.x += 10; sendDataToFirebase(); });
        upButton.addEventListener('touchstart', () => { player.y -= 10; sendDataToFirebase(); });
        downButton.addEventListener('touchstart', () => { player.y += 10; sendDataToFirebase(); });

        const connectToNewUser = (id, otherPlayer) => {
            const peerConnection = new RTCPeerConnection(config);
            peers[id] = peerConnection;

            localStream.getTracks().forEach((track) => peerConnection.addTrack(track, localStream));
            peerConnection.ontrack = (event) => {
                const [remoteStream] = event.streams;
                addVideoStream(remoteStream, id, otherPlayer.x, otherPlayer.y);
            };

            peerConnection.createOffer().then((offer) => {
                peerConnection.setLocalDescription(offer);
                push(ref(db, `signals/${id}`), {
                    from: playerId,
                    offer: offer
                });
            });

            onValue(ref(db, `signals/${playerId}`), (snapshot) => {
                const signals = snapshot.val();
                if (!signals) return;

                Object.keys(signals).forEach((key) => {
                    const { from, offer, answer } = signals[key];
                    if (from === id && offer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                            .then(() => peerConnection.createAnswer())
                            .then((answer) => {
                                peerConnection.setLocalDescription(answer);
                                push(ref(db, `signals/${from}`), { from: playerId, answer });
                            });
                    }
                    if (answer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });
            });
        };

        window.addEventListener('beforeunload', () => {
            remove(ref(db, `players/${player.id}`));
        });

        sendDataToFirebase();
    </script>
</body>
</html>
