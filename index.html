<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Meeting</title>
</head>
<body>
  <h1>Video Meeting</h1>
  <div id="videos"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
      authDomain: "videjo-d0996.firebaseapp.com",
      databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "videjo-d0996",
      storageBucket: "videjo-d0996.firebasestorage.app",
      messagingSenderId: "175126755237",
      appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
      measurementId: "G-6Q2BJX1FE5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Helper to get a unique user ID
    const userId = Math.random().toString(36).substring(2, 15);

    // Get camera stream and display it
    const startCamera = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

      // Display user's own video
      const video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      video.muted = true;
      video.width = 200;
      document.getElementById('videos').appendChild(video);

      // Send stream data to Firebase
      set(ref(db, `users/${userId}`), {
        userId,
        timestamp: Date.now()
      });

      return stream;
    };

    // Remove user from Firebase on page unload
    window.addEventListener("beforeunload", () => {
      remove(ref(db, `users/${userId}`));
    });

    // Display other users' streams
    const updateVideos = () => {
      onValue(ref(db, "users"), (snapshot) => {
        const users = snapshot.val();
        const container = document.getElementById('videos');
        container.innerHTML = ""; // Clear videos before rendering

        for (const id in users) {
          if (id === userId) continue; // Skip current user's video

          const videoPlaceholder = document.createElement('div');
          videoPlaceholder.innerText = `User ${id}`;
          videoPlaceholder.style.border = "1px solid black";
          videoPlaceholder.style.width = "200px";
          videoPlaceholder.style.height = "150px";
          videoPlaceholder.style.background = "gray";
          videoPlaceholder.style.margin = "10px";

          container.appendChild(videoPlaceholder);
        }
      });
    };

    // Initialize the app
    (async () => {
      await startCamera();
      updateVideos();
    })();
  </script>
</body>
</html>
