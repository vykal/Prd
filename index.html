<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Meeting</title>
  <style>
    #videos {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    video {
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 200px;
      height: 150px;
      object-fit: cover;
    }
    .placeholder {
      border: 1px solid black;
      width: 200px;
      height: 150px;
      background: gray;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Video Meeting</h1>
  <div id="videos"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
      authDomain: "videjo-d0996.firebaseapp.com",
      databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "videjo-d0996",
      storageBucket: "videjo-d0996.firebasestorage.app",
      messagingSenderId: "175126755237",
      appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
      measurementId: "G-6Q2BJX1FE5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get unique user ID
    const userId = Math.random().toString(36).substring(2, 15);

    // Function to start the camera
    const startCamera = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

        // Display the user's own video
        const videoElement = document.createElement('video');
        videoElement.srcObject = stream;
        videoElement.autoplay = true;
        videoElement.muted = true;
        document.getElementById('videos').appendChild(videoElement);

        // Notify the database about the new user
        set(ref(db, `users/${userId}`), {
          userId,
          timestamp: Date.now()
        });

        return stream;
      } catch (error) {
        console.error("Error accessing camera:", error);
        alert("Camera access is required to use this application.");
      }
    };

    // Update videos for other users
    const updateVideos = () => {
      onValue(ref(db, "users"), (snapshot) => {
        const users = snapshot.val() || {};
        const videoContainer = document.getElementById('videos');
        const userIds = Object.keys(users);

        // Clear the container and re-add videos
        videoContainer.innerHTML = "";

        userIds.forEach((id) => {
          if (id === userId) return; // Skip own video

          // Placeholder for other users (replace with WebRTC for real video streams)
          const placeholder = document.createElement('div');
          placeholder.className = 'placeholder';
          placeholder.innerText = `User ${id}`;
          videoContainer.appendChild(placeholder);
        });
      });
    };

    // Remove user from Firebase on unload
    window.addEventListener("beforeunload", () => {
      remove(ref(db, `users/${userId}`));
    });

    // Initialize
    (async () => {
      await startCamera();
      updateVideos();
    })();
  </script>
</body>
</html>
