<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stretnutie</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
    <style>
        body {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        #video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        video {
            width: 300px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #000;
        }
        h1 {
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Video Stretnutie</h1>
    <div id="video-container"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, push, onChildAdded, onChildRemoved, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
            authDomain: "videjo-d0996.firebaseapp.com",
            databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "videjo-d0996",
            storageBucket: "videjo-d0996.appspot.com",
            messagingSenderId: "175126755237",
            appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
            measurementId: "G-6Q2BJX1FE5"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const userId = `user_${Math.random().toString(36).substr(2, 9)}`;
        const usersRef = ref(database, "users");
        const videoContainer = document.getElementById("video-container");

        let localStream = null;
        const peerConnections = {};
        const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // Funkcia na pridanie videa do kontajnera
        function createVideoElement(stream, muted = false) {
            const video = document.createElement("video");
            video.autoplay = true;
            video.muted = muted;
            video.srcObject = stream;
            videoContainer.appendChild(video);
        }

        // Získanie prístupu ku kamere a mikrofónu
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                createVideoElement(localStream, true); // Lokálne video
                registerUser();
                setupListeners();
            })
            .catch(err => console.error("Prístup ku kamere bol zamietnutý:", err));

        // Registrácia používateľa do Firebase
        function registerUser() {
            const userRef = ref(database, `users/${userId}`);
            set(userRef, { id: userId, timestamp: Date.now() });
            window.addEventListener("beforeunload", () => remove(userRef));
        }

        // Nastavenie Firebase poslucháčov
        function setupListeners() {
            onChildAdded(usersRef, snapshot => {
                const newUserId = snapshot.val().id;
                if (newUserId !== userId) {
                    setupPeerConnection(newUserId);
                }
            });

            onChildRemoved(usersRef, snapshot => {
                const removedUserId = snapshot.val().id;
                if (peerConnections[removedUserId]) {
                    peerConnections[removedUserId].close();
                    delete peerConnections[removedUserId];
                }
            });
        }

        // Nastavenie PeerConnection pre nového používateľa
        function setupPeerConnection(remoteUserId) {
            const peerConnection = new RTCPeerConnection(configuration);
            peerConnections[remoteUserId] = peerConnection;

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    push(ref(database, `candidates/${remoteUserId}`), {
                        from: userId,
                        candidate: event.candidate
                    });
                }
            };

            peerConnection.ontrack = event => {
                createVideoElement(event.streams[0]); // Pridanie vzdialeného videa
            };

            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    set(ref(database, `offers/${remoteUserId}`), {
                        from: userId,
                        offer: peerConnection.localDescription
                    });
                });

            listenForAnswer(remoteUserId);
        }

        function listenForAnswer(remoteUserId) {
            const answersRef = ref(database, `answers/${userId}`);
            onChildAdded(answersRef, snapshot => {
                const data = snapshot.val();
                if (data && data.from === remoteUserId) {
                    peerConnections[remoteUserId].setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
        }

        const offersRef = ref(database, `offers/${userId}`);
        onChildAdded(offersRef, snapshot => {
            const data = snapshot.val();
            if (data && !peerConnections[data.from]) {
                const peerConnection = new RTCPeerConnection(configuration);
                peerConnections[data.from] = peerConnection;

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        push(ref(database, `candidates/${data.from}`), {
                            from: userId,
                            candidate: event.candidate
                        });
                    }
                };

                peerConnection.ontrack = event => {
                    createVideoElement(event.streams[0]); // Pridanie vzdialeného videa
                };

                peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        set(ref(database, `answers/${data.from}`), {
                            from: userId,
                            answer: peerConnection.localDescription
                        });
                    });

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }
        });

        const candidatesRef = ref(database, "candidates");
        onChildAdded(candidatesRef, snapshot => {
            const data = snapshot.val();
            if (data && peerConnections[data.from]) {
                const candidate = new RTCIceCandidate(data.candidate);
                peerConnections[data.from].addIceCandidate(candidate);
            }
        });
    </script>
</body>
</html>
