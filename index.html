<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Meeting</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: lightblue;
        }

        #videos {
            position: relative;
            width: 100%;
            height: 100%;
        }

        video {
            position: absolute;
            width: 200px;
            height: 150px;
            object-fit: cover;
            border: 2px solid white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<div id="videos"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
        authDomain: "videjo-d0996.firebaseapp.com",
        databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "videjo-d0996",
        storageBucket: "videjo-d0996.firebasestorage.app",
        messagingSenderId: "175126755237",
        appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
        measurementId: "G-6Q2BJX1FE5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Unique player ID
    const playerId = `player_${Math.random().toString(36).substring(2, 9)}`;
    const playerRef = ref(db, `players/${playerId}`);
    const playersRef = ref(db, 'players');

    // Local video setup
    const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const videoContainer = document.getElementById('videos');
    const localVideo = document.createElement('video');
    localVideo.srcObject = localStream;
    localVideo.autoplay = true;
    localVideo.muted = true;
    videoContainer.appendChild(localVideo);

    // Player object
    const player = {
        id: playerId,
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight,
        width: 200,
        height: 150,
        stream: localStream,
    };

    // Send player data to Firebase
    set(playerRef, {
        id: player.id,
        x: player.x,
        y: player.y,
    });

    // Handle player disconnection
    window.addEventListener('beforeunload', () => {
        remove(playerRef);
    });

    // Move player
    const movePlayer = (dx, dy) => {
        player.x += dx;
        player.y += dy;
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > window.innerWidth) player.x = window.innerWidth - player.width;
        if (player.y < 0) player.y = 0;
        if (player.y + player.height > window.innerHeight) player.y = window.innerHeight - player.height;

        localVideo.style.left = `${player.x}px`;
        localVideo.style.top = `${player.y}px`;

        set(playerRef, { id: player.id, x: player.x, y: player.y });
    };

    // Add event listeners for movement
    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') movePlayer(-10, 0);
        if (e.key === 'ArrowRight') movePlayer(10, 0);
        if (e.key === 'ArrowUp') movePlayer(0, -10);
        if (e.key === 'ArrowDown') movePlayer(0, 10);
    });

    // Handle other players
    const otherPlayers = {};
    onValue(playersRef, (snapshot) => {
        const players = snapshot.val() || {};
        Object.keys(players).forEach((id) => {
            if (id !== playerId) {
                if (!otherPlayers[id]) {
                    const video = document.createElement('video');
                    video.autoplay = true;
                    videoContainer.appendChild(video);
                    otherPlayers[id] = { video };
                }
                const { x, y } = players[id];
                otherPlayers[id].video.style.left = `${x}px`;
                otherPlayers[id].video.style.top = `${y}px`;
            }
        });
    });
</script>
</body>
</html>
