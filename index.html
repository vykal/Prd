<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktívny Video Meeting</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            background: lightblue;
        }

        #videos {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        video {
            position: absolute;
            border: 2px solid white;
            border-radius: 10px;
            width: 100px;
            height: 75px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="videos"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyACWLI7L0zhZk7RFQyEXlOyQjtMPF-MgDw",
            authDomain: "hrav-1a742.firebaseapp.com",
            databaseURL: "https://hrav-1a742-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hrav-1a742",
            storageBucket: "hrav-1a742.appspot.com",
            messagingSenderId: "1093772001619",
            appId: "1:1093772001619:web:97d8e6dd9d5cd28da761a6"
        };

        // Inicializácia Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const videosContainer = document.getElementById('videos');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Generovanie unikátneho ID pre hráča
        const playerId = `player_${Math.random().toString(36).substring(2, 9)}`;
        const player = {
            id: playerId,
            x: Math.random() * (canvas.width - 100),
            y: Math.random() * (canvas.height - 75),
            width: 100,
            height: 75
        };

        const players = {};

        // WebRTC konfigurácia
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        const peers = {};
        const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

        // Pridanie lokálneho video streamu
        const addVideoStream = (stream, id, x, y) => {
            let video = document.querySelector(`video[data-id="${id}"]`);
            if (!video) {
                video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.dataset.id = id;
                video.style.left = `${x}px`;
                video.style.top = `${y}px`;
                videosContainer.appendChild(video);
            }
        };

        addVideoStream(localStream, playerId, player.x, player.y);

        // Posielanie dát do Firebase
        function sendDataToFirebase() {
            set(ref(db, `players/${player.id}`), {
                ...player,
                x: player.x,
                y: player.y
            });
        }

        // Počúvanie zmien v databáze
        onValue(ref(db, 'players'), (snapshot) => {
            const data = snapshot.val() || {};
            Object.keys(data).forEach((id) => {
                if (id !== playerId) {
                    const otherPlayer = data[id];
                    if (!peers[id]) connectToNewUser(id, otherPlayer);
                    const video = document.querySelector(`video[data-id="${id}"]`);
                    if (video) {
                        video.style.left = `${otherPlayer.x}px`;
                        video.style.top = `${otherPlayer.y}px`;
                    }
                }
            });
        });

        // Pohyb hráča
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowLeft':
                    player.x -= 10;
                    break;
                case 'ArrowRight':
                    player.x += 10;
                    break;
                case 'ArrowUp':
                    player.y -= 10;
                    break;
                case 'ArrowDown':
                    player.y += 10;
                    break;
            }
            sendDataToFirebase();
        });

        // WebRTC Signaling
        const connectToNewUser = (id, otherPlayer) => {
            const peerConnection = new RTCPeerConnection(config);
            peers[id] = peerConnection;

            localStream.getTracks().forEach((track) => peerConnection.addTrack(track, localStream));
            peerConnection.ontrack = (event) => {
                const [remoteStream] = event.streams;
                addVideoStream(remoteStream, id, otherPlayer.x, otherPlayer.y);
            };

            peerConnection.createOffer().then((offer) => {
                peerConnection.setLocalDescription(offer);
                push(ref(db, `signals/${id}`), {
                    from: playerId,
                    offer: offer
                });
            });

            onValue(ref(db, `signals/${playerId}`), (snapshot) => {
                const signals = snapshot.val();
                if (!signals) return;

                Object.keys(signals).forEach((key) => {
                    const { from, offer, answer } = signals[key];
                    if (from === id && offer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                            .then(() => peerConnection.createAnswer())
                            .then((answer) => {
                                peerConnection.setLocalDescription(answer);
                                push(ref(db, `signals/${from}`), { from: playerId, answer });
                            });
                    }
                    if (answer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });
            });
        };

        // Odstránenie hráča pri odpojení
        window.addEventListener('beforeunload', () => {
            remove(ref(db, `players/${player.id}`));
        });

        // Inicializácia
        sendDataToFirebase();
    </script>
</body>
</html>
