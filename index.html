<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stretnutie</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
    <style>
        body {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        video {
            width: 300px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <script type="module">
        // Import potrebných knižníc Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyB-sXXU2-dWigTrpYp1hnWbDjqqJ2gr0Yw",
            authDomain: "videjo-d0996.firebaseapp.com",
            databaseURL: "https://videjo-d0996-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "videjo-d0996",
            storageBucket: "videjo-d0996.appspot.com",
            messagingSenderId: "175126755237",
            appId: "1:175126755237:web:8cf31d7a4d08f9fb2bda4c",
            measurementId: "G-6Q2BJX1FE5"
        };

        // Inicializácia Firebase aplikácie
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Generovanie jedinečného ID pre používateľa
        const userId = `user_${Math.random().toString(36).substr(2, 9)}`;

        // Video element pre lokálny stream
        const localVideo = document.createElement("video");
        localVideo.autoplay = true;
        localVideo.muted = true;
        document.body.appendChild(localVideo);

        // Pripojenie ku kamere
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(stream => {
                localVideo.srcObject = stream;

                // Uloženie údajov používateľa do databázy
                const userRef = ref(database, `users/${userId}`);
                set(userRef, { id: userId, timestamp: Date.now() });

                // Odstránenie používateľa z databázy pri odchode
                window.addEventListener("beforeunload", () => {
                    remove(userRef);
                });
            })
            .catch(err => {
                console.error("Prístup ku kamere bol zamietnutý:", err);
            });

        // Načítanie zoznamu pripojených používateľov
        const usersRef = ref(database, "users");
        onValue(usersRef, snapshot => {
            const users = snapshot.val();
            document.querySelectorAll("video.remote").forEach(video => video.remove());

            if (users) {
                Object.keys(users).forEach(key => {
                    if (key !== userId) {
                        const remoteVideo = document.createElement("video");
                        remoteVideo.classList.add("remote");
                        remoteVideo.autoplay = true;
                        document.body.appendChild(remoteVideo);

                        // V tomto kóde sa video stream iných používateľov nezobrazuje.
                        // Na zdieľanie video streamov by sa musel implementovať WebRTC.
                    }
                });
            }
        });
    </script>
</body>
</html>
